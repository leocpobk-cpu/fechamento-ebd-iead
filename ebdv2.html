<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gest√£o EBD Completa</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --border: #e5e7eb;
            --success: #25D366;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 100px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        header h1 { font-size: 1.1rem; font-weight: 600; }

        .container { max-width: 700px; margin: 0 auto; padding: 10px; }

        /* Data */
        .date-container {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        /* Estilo Diferente para Professores */
        .card.special-group {
            border: 2px solid var(--warning);
            background-color: #fffbf0;
        }
        .card.special-group .card-title { color: #d97706; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 5px;
        }

        .card-title { font-weight: 700; color: var(--primary); font-size: 1rem; }
        .card-subtitle { font-size: 0.8rem; color: #6b7280; font-style: italic; }

        /* Grids de Input */
        .row-main { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .row-secondary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .row-money { display: grid; grid-template-columns: 1fr; gap: 8px; }

        .form-group { display: flex; flex-direction: column; }
        
        label { font-size: 0.7rem; font-weight: 600; color: #4b5563; margin-bottom: 2px; text-transform: uppercase; }
        
        input[type="number"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem; /* Tamanho bom para toque */
            background: #fff;
        }

        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Indicadores autom√°ticos */
        .auto-calc {
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            padding: 4px;
            border-radius: 4px;
            background: #e5e7eb;
            color: #374151;
            margin-top: 2px;
        }
        .bg-red { background: #fee2e2; color: #b91c1c; } /* Faltantes */
        .bg-blue { background: #dbeafe; color: #1e40af; } /* % */

        /* Bot√µes de A√ß√£o */
        .fab-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            z-index: 100;
        }

        .btn {
            width: 100%;
            max-width: 600px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; margin-top: 8px; }
        .btn-secondary { background-color: var(--secondary); color: white; margin-top: 8px; }
        .btn-outline { background: white; color: #666; border: 1px solid #ccc; margin-top: 8px; }

        /* RELAT√ìRIO */
        #tela-relatorio { display: none; }
        
        .report-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Resumo Geral Cards */
        .summary-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .sum-card { background: var(--primary); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .sum-val { font-size: 1.5rem; font-weight: bold; }
        .sum-lbl { font-size: 0.8rem; opacity: 0.9; }
        
        .details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .detail-item { background: rgba(255,255,255,0.2); padding: 5px; border-radius: 5px; }
        .d-val { font-weight: bold; } .d-lbl { font-size: 0.6rem; }

        /* Tabela */
        .table-container { overflow-x: auto; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        .report-table th { text-align: center; background: #f3f4f6; padding: 6px; border: 1px solid #e5e7eb; }
        .report-table td { padding: 6px; border: 1px solid #e5e7eb; text-align: center; }
        .report-table td:first-child { text-align: left; font-weight: bold; }
        .bg-total { background-color: #f0f9ff; font-weight: bold; }

        /* Se√ß√£o Professores no Relat√≥rio */
        .prof-section { margin-top: 20px; border: 1px dashed var(--warning); padding: 10px; border-radius: 8px; background: #fffbf0; }
        .prof-header { color: #d97706; font-weight: bold; margin-bottom: 5px; }

        /* IMPRESS√ÉO */
        @media print {
            body { background: white; padding: 0; }
            header, .fab-container, #tela-formulario, .no-print { display: none !important; }
            #tela-relatorio { display: block !important; }
            .sum-card { background: #eee !important; color: black !important; border: 1px solid #000; }
            .detail-item { background: none; border: 1px solid #ccc; }
            .report-table th { background: #ddd !important; -webkit-print-color-adjust: exact; }
            .prof-section { border: 2px solid #000; }
        }
    </style>
</head>
<body>

    <!-- TELA DE LAN√áAMENTO -->
    <div id="tela-formulario">
        <header>
            <h1>Lan√ßamento EBD</h1>
        </header>

        <div class="container">
            <div class="date-container">
                <label>Data do Relat√≥rio</label>
                <input type="date" id="data-culto">
            </div>

            <div id="grupos-container"></div>
        </div>

        <div class="fab-container">
            <button class="btn btn-primary" onclick="gerarRelatorio()">GERAR RELAT√ìRIO</button>
        </div>
    </div>

    <!-- TELA DE RELAT√ìRIO (Final) -->
    <div id="tela-relatorio" class="container">
        
        <div class="report-header">
            <h2>Relat√≥rio Geral EBD</h2>
            <p id="res-data" style="color: #666;">--/--/----</p>
        </div>
        
        <!-- Big Numbers -->
        <div class="summary-cards">
            <div class="sum-card">
                <div class="sum-lbl">OFERTA TOTAL</div>
                <div class="sum-val" id="res-oferta-total">R$ 0,00</div>
            </div>
            <div class="sum-card">
                <div class="sum-lbl">% PRESEN√áA GERAL</div>
                <div class="sum-val" id="res-percentual">0%</div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="sum-card" style="grid-column: span 2; margin-top: -5px; padding: 10px;">
            <div class="details-grid">
                <div class="detail-item">
                    <div class="d-val" id="res-matriculados">0</div>
                    <div class="d-lbl">Matriculados</div>
                </div>
                <div class="detail-item">
                    <div class="d-val" id="res-presentes">0</div>
                    <div class="d-lbl">Presentes</div>
                </div>
                <div class="detail-item">
                    <div class="d-val" id="res-visitantes">0</div>
                    <div class="d-lbl">Visitantes</div>
                </div>
                <div class="detail-item" style="margin-top:5px">
                    <div class="d-val" id="res-faltantes">0</div>
                    <div class="d-lbl">Faltantes</div>
                </div>
                <div class="detail-item" style="margin-top:5px">
                    <div class="d-val" id="res-biblias">0</div>
                    <div class="d-lbl">B√≠blias</div>
                </div>
                <div class="detail-item" style="margin-top:5px">
                    <div class="d-val" id="res-revistas">0</div>
                    <div class="d-lbl">Revistas</div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h3 style="margin: 15px 0 5px 0; font-size: 1rem;">Detalhamento por Classe</h3>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Mat</th>
                        <th>Pres</th>
                        <th>Falta</th>
                        <th>Visit</th>
                        <th>B√≠b</th>
                        <th>Rev</th>
                        <th>Oferta</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo"></tbody>
            </table>
        </div>

        <!-- Se√ß√£o Professores -->
        <div class="prof-section">
            <div class="prof-header">Controle Interno - Professores</div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Classe</th>
                        <th>Mat</th>
                        <th>Pres</th>
                        <th>Falta</th>
                        <th>B√≠b</th>
                        <th>Rev</th>
                        <th>Oferta</th>
                    </tr>
                </thead>
                <tbody id="tabela-professores"></tbody>
            </table>
            <div style="font-size: 0.7rem; margin-top: 5px; text-align: center; color: #666;">
                * N√£o contabilizado nos totais gerais acima.
            </div>
        </div>

        <div class="no-print" style="margin-top: 20px; margin-bottom: 50px;">
            <button class="btn btn-success" onclick="enviarWhatsapp()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.598 2.669-.702c1.024.551 1.655.723 2.853.723 3.251 0 5.836-2.586 5.837-5.766.001-3.181-2.585-5.861-5.899-5.906zM12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22c-4.411 0-8.128-2.685-9.736-6.527l-1.527-5.586 5.635 1.504C7.912 11.936 12 16.492 12 16.492s4.088-4.556 5.628-5.101l5.635-1.504-1.527 5.586C20.128 19.315 16.411 22 12 22z"/></svg>
                ENVIAR NO WHATSAPP
            </button>
            <button class="btn btn-secondary" onclick="window.print()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
                SALVAR PDF / IMPRIMIR
            </button>
            <button class="btn btn-outline" onclick="voltar()">Voltar / Editar</button>
        </div>
    </div>

<script>
    // Configura√ß√£o Inicial
    window.onload = function() {
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data-culto').value = hoje;
    }

    // isSeparate: true = N√£o soma no relat√≥rio geral (Professores)
    const grupos = [
        { id: 'jardim', nome: 'Crian√ßas', sub: 'Jardim de Deus', isSeparate: false },
        { id: 'pedacinho', nome: 'Crian√ßas', sub: 'Pedacinho do C√©u', isSeparate: false },
        { id: 'adolescentes', nome: 'Adolescentes', sub: 'Manancial', isSeparate: false },
        { id: 'jovens', nome: 'Jovens', sub: 'Embaixadores', isSeparate: false },
        { id: 'novos', nome: 'Novos Conv.', sub: 'Discipulado', isSeparate: false },
        { id: 'irmas', nome: 'Irm√£s', sub: 'Dorcas', isSeparate: false },
        { id: 'varoes', nome: 'Var√µes', sub: 'Abra√£o', isSeparate: false },
        { id: 'professores', nome: 'Professores', sub: 'EBD', isSeparate: true } // Controle separado
    ];

    const container = document.getElementById('grupos-container');
    
    // Gerar Cards
    grupos.forEach(grupo => {
        const specialClass = grupo.isSeparate ? 'special-group' : '';
        const titleNote = grupo.isSeparate ? '(Controle Separado)' : '';
        
        const html = `
        <div class="card ${specialClass}">
            <div class="card-header">
                <div>
                    <div class="card-title">${grupo.nome} <span style="font-size:0.7em; font-weight:normal">${titleNote}</span></div>
                    <div class="card-subtitle">${grupo.sub}</div>
                </div>
            </div>
            
            <!-- Linha 1: Matriculados, Presentes, Faltantes (Auto) -->
            <div class="row-main">
                <div class="form-group">
                    <label>Matric.</label>
                    <input type="number" id="mat-${grupo.id}" placeholder="0" inputmode="numeric" oninput="calcFaltas('${grupo.id}')">
                </div>
                <div class="form-group">
                    <label>Presentes</label>
                    <input type="number" id="pres-${grupo.id}" placeholder="0" inputmode="numeric" oninput="calcFaltas('${grupo.id}')">
                </div>
                <div class="form-group">
                    <label>Faltantes</label>
                    <div id="falta-display-${grupo.id}" class="auto-calc bg-red">0</div>
                </div>
            </div>

            <!-- Linha 2: Visitantes, B√≠blias, Revistas -->
            <div class="row-secondary">
                <div class="form-group">
                    <label>Visitantes</label>
                    <input type="number" id="vis-${grupo.id}" placeholder="0" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label>B√≠blias</label>
                    <input type="number" id="bib-${grupo.id}" placeholder="0" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label>Revistas</label>
                    <input type="number" id="rev-${grupo.id}" placeholder="0" inputmode="numeric">
                </div>
            </div>

            <!-- Linha 3: Oferta -->
            <div class="row-money">
                <div class="form-group">
                    <div style="display:flex; justify-content:space-between;">
                        <label>Oferta (R$)</label>
                        <div id="perc-display-${grupo.id}" style="font-size:0.7rem; color:blue; font-weight:bold">0% Freq.</div>
                    </div>
                    <input type="number" id="oferta-${grupo.id}" step="0.01" placeholder="0,00" inputmode="decimal">
                </div>
            </div>
        </div>`;
        container.innerHTML += html;
    });

    // Fun√ß√£o que roda enquanto digita para calcular faltas e % visual
    function calcFaltas(id) {
        const mat = parseInt(document.getElementById(`mat-${id}`).value) || 0;
        const pres = parseInt(document.getElementById(`pres-${id}`).value) || 0;
        
        // Faltantes (n√£o deixa ser negativo)
        let faltas = mat - pres;
        if(faltas < 0) faltas = 0;
        
        // Percentual
        let perc = 0;
        if(mat > 0) perc = (pres / mat) * 100;

        // Atualiza visual
        document.getElementById(`falta-display-${id}`).innerText = faltas;
        document.getElementById(`perc-display-${id}`).innerText = perc.toFixed(0) + "% Freq.";
    }

    function gerarRelatorio() {
        const dataRaw = document.getElementById('data-culto').value;
        const dataFormatada = dataRaw ? new Date(dataRaw + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data n√£o informada';

        // Vari√°veis de totais (Apenas para grupos N√ÉO separados)
        let tMat = 0, tPres = 0, tVis = 0, tFalta = 0, tBib = 0, tRev = 0, tOferta = 0;
        
        let htmlGeral = '';
        let htmlProf = '';
        let zapText = `*RELAT√ìRIO EBD - ${dataFormatada}*\n\n`;

        grupos.forEach(grupo => {
            // Pegar valores
            const mat = parseInt(document.getElementById(`mat-${grupo.id}`).value) || 0;
            const pres = parseInt(document.getElementById(`pres-${grupo.id}`).value) || 0;
            const vis = parseInt(document.getElementById(`vis-${grupo.id}`).value) || 0;
            const bib = parseInt(document.getElementById(`bib-${grupo.id}`).value) || 0;
            const rev = parseInt(document.getElementById(`rev-${grupo.id}`).value) || 0;
            const oferta = parseFloat(document.getElementById(`oferta-${grupo.id}`).value) || 0;

            // C√°lculos Individuais
            let faltas = mat - pres; if(faltas < 0) faltas = 0;
            let perc = mat > 0 ? (pres / mat) * 100 : 0;

            // Linha da Tabela HTML
            const tr = `
            <tr>
                <td>${grupo.sub}<br><span style="font-size:0.6em;color:#666">${grupo.nome}</span></td>
                <td>${mat}</td>
                <td>${pres} <span style="font-size:0.6em;color:blue">(${perc.toFixed(0)}%)</span></td>
                <td style="color:red; font-weight:bold">${faltas}</td>
                <td>${vis > 0 ? vis : '-'}</td>
                <td>${bib}</td>
                <td>${rev}</td>
                <td>${formatarMoeda(oferta)}</td>
            </tr>`;

            // L√≥gica de separa√ß√£o (Professores vs Geral)
            if (grupo.isSeparate) {
                // √â Professor: Adiciona na tabela de professores, N√ÉO soma nos totais
                htmlProf += tr;
                // No zap, adiciona em se√ß√£o separada no final (trataremos depois do loop)
            } else {
                // √â grupo comum: Soma nos totais
                tMat += mat;
                tPres += pres;
                tVis += vis;
                tFalta += faltas;
                tBib += bib;
                tRev += rev;
                tOferta += oferta;
                htmlGeral += tr;

                // Adiciona ao texto do Zap (Grupos normais)
                zapText += `*${grupo.sub}*\n`;
                zapText += `üë• Mat: ${mat} | Pres: ${pres} | Falta: ${faltas}\n`;
                zapText += `üÜï Vis: ${vis} | üìñ B√≠b: ${bib} | üìò Rev: ${rev}\n`;
                zapText += `üí∞ Oferta: ${formatarMoeda(oferta)}\n\n`;
            }
        });

        // C√°lculo Totais Gerais
        const tPerc = tMat > 0 ? (tPres / tMat) * 100 : 0;

        // Preencher Tela Relat√≥rio
        document.getElementById('res-data').innerText = dataFormatada;
        document.getElementById('res-oferta-total').innerText = formatarMoeda(tOferta);
        document.getElementById('res-percentual').innerText = tPerc.toFixed(1) + "%";
        
        document.getElementById('res-matriculados').innerText = tMat;
        document.getElementById('res-presentes').innerText = tPres;
        document.getElementById('res-visitantes').innerText = tVis;
        document.getElementById('res-faltantes').innerText = tFalta;
        document.getElementById('res-biblias').innerText = tBib;
        document.getElementById('res-revistas').innerText = tRev;

        document.getElementById('tabela-corpo').innerHTML = htmlGeral;
        document.getElementById('tabela-professores').innerHTML = htmlProf;

        // Adicionar Professores e Resumo ao Zap
        
        // 1. Adicionar se√ß√£o de Professores ao Zap se houver dados
        const profMat = parseInt(document.getElementById('mat-professores').value) || 0;
        const profPres = parseInt(document.getElementById('pres-professores').value) || 0;
        if(profMat > 0 || profPres > 0) {
            zapText += `----------------\n*üéì CLASSE PROFESSORES (Controle)*\n`;
            zapText += `Presen√ßa: ${profPres}/${profMat} | Oferta: ${formatarMoeda(parseFloat(document.getElementById('oferta-professores').value)||0)}\n\n`;
        }

        // 2. Resumo Geral Zap
        zapText += `================\n*RESUMO GERAL (Sem Profs)*\n`;
        zapText += `üìÖ Data: ${dataFormatada}\n`;
        zapText += `üí∞ *TOTAL OFERTA: ${formatarMoeda(tOferta)}*\n`;
        zapText += `üìä Presen√ßa M√©dia: ${tPerc.toFixed(1)}%\n`;
        zapText += `üë• Total Mat: ${tMat} | ‚úÖ Pres: ${tPres}\n`;
        zapText += `‚ùå Faltas: ${tFalta} | üÜï Visit: ${tVis}\n`;
        zapText += `üìñ B√≠blias: ${tBib} | üìò Revistas: ${tRev}`;

        window.textoZap = zapText;

        document.getElementById('tela-formulario').style.display = 'none';
        document.getElementById('tela-relatorio').style.display = 'block';
        window.scrollTo(0,0);
    }

    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function voltar() {
        document.getElementById('tela-relatorio').style.display = 'none';
        document.getElementById('tela-formulario').style.display = 'block';
    }

    function enviarWhatsapp() {
        const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(window.textoZap)}`;
        window.open(url, '_blank');
    }
</script>

</body>
</html>

